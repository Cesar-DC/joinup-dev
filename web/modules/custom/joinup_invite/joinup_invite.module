<?php

/**
 * @file
 * Hook implementations for the Joinup Invite module.
 */

use Drupal\Core\Block\BlockPluginInterface;
use Drupal\Core\Cache\Cache;
use Drupal\Core\Entity\ContentEntityInterface;
use Drupal\Core\Entity\EntityInterface;
use Drupal\Core\Form\FormStateInterface;
use Drupal\Core\Url;
use Drupal\joinup_invite\Entity\Invitation;
use Drupal\joinup_invite\Entity\InvitationInterface;
use Drupal\og\OgMembershipInterface;

/**
 * Implements hook_user_cancel().
 *
 * A user account cancellation removes all its invitations.
 */
function joinup_invite_user_cancel($edit, $account, $method) {
  $storage = \Drupal::entityTypeManager()->getStorage('invitation');
  /** @var \Drupal\user\UserInterface $account */
  if ($ids = $storage->getQuery()->condition('uid', $account->id())->execute()) {
    $storage->delete($storage->loadMultiple($ids));
  }
}

/**
 * Implements hook_entity_delete().
 *
 * A content entity deletion should cleanup the related invitations.
 */
function joinup_invite_entity_delete(EntityInterface $entity) {
  if ($entity instanceof ContentEntityInterface) {
    $storage = \Drupal::entityTypeManager()->getStorage('invitation');
    $ids = $storage->getQuery()
      ->condition('entity_type', $entity->getEntityTypeId())
      ->condition('entity_id', $entity->id())
      ->execute();
    if ($ids) {
      $storage->delete($storage->loadMultiple($ids));
    }
  }
}

/**
 * Implements hook_block_view_alter().
 *
 * Set the og_role cache contexts to the local tasks block.
 */
function joinup_invite_block_view_alter(array &$build, BlockPluginInterface $block) {
  if ($build['#id'] === 'primaryadminactions') {
    // The primaryadminactions contains the 'Add facilitator' link which is
    // accessible only to facilitators. The members page though is accessible
    // by members as well. If a normal member visits the page first, the block
    // is build without the og_role context and the form does not vary per group
    // role.
    // Make sure that the primaryadminactions block varies per og role.
    $cache_contexts = $build['#cache']['contexts'] ?? [];
    $build['#cache']['contexts'] = Cache::mergeContexts($cache_contexts, ['og_role']);
  }
}

/**
 * Implements hook_ENTITY_TYPE_delete().
 *
 * If a membership is deleted and an invitation exists for the same group and
 * user, delete the invitation as well.
 */
function joinup_invite_og_membership_delete(OgMembershipInterface $entity) {
  $invitations = \Drupal::entityTypeManager()->getStorage('invitation')->loadByProperties([
    'entity_type' => $entity->getGroupEntityType(),
    'entity_id' => $entity->getGroupId(),
    'recipient_id' => $entity->getOwnerId(),
    'bundle' => 'group',
  ]);

  // Normally, only one invitation should exist per entity and user, but iterate
  // nonetheless.
  foreach ($invitations as $invitation) {
    $invitation->delete();
  }
}

/**
 * Implements hook_form_FORM_ID_alter().
 */
function joinup_invite_form_join_collection_form_alter(&$form, FormStateInterface $form_state, $form_id) {
  $user = $form_state->get('user');
  $collection = $form_state->get('collection');
  if (empty($user) || empty($collection)) {
    return;
  }

  /** @var \Drupal\og\MembershipManagerInterface $membership_manager */
  $membership_manager = \Drupal::service('og.membership_manager');
  $membership = $membership_manager->getMembership($collection, $user);
  $invitation = Invitation::loadByEntityAndUser($collection, $user, 'group');
  if (($membership && $membership->getState() === OgMembershipInterface::STATE_PENDING) ||
    ($invitation && $invitation->getStatus() === InvitationInterface::STATUS_PENDING)) {
    unset($form['join']);
    unset($form['leave']);
    $form['pending'] = [
      '#type' => 'link',
      '#title' => t('Membership is pending'),
      '#url' => Url::fromRoute('<current>', [], ['fragment' => 'pending']),
      '#attributes' => [
        'class' => [
          'button',
          'button--blue-light',
          'mdl-button',
          'mdl-js-button',
          'mdl-button--raised',
          'mdl-js-ripple-effect',
          'mdl-button--accent',
          'button--small',
        ],
      ],
    ];
  }
}
