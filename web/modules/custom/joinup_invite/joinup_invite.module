<?php

/**
 * @file
 * Hook implementations for the Joinup Invite module.
 */

use Drupal\joinup_invite\Entity\InvitationInterface;

/**
 * Implements hook_ENTITY_TYPE_update().
 */
function joinup_invite_invitation_update(InvitationInterface $invitation) {
  switch ($invitation->bundle()) {
    case 'discussion':
      // After an invitation to participate in a discussion has been accepted or
      // rejected we should (un)subscribe the user and show them a success
      // message.
      if (!empty($invitation->original) && $invitation->original->get('status')->value !== $invitation->get('status')->value) {
        /** @var \Drupal\flag\FlagServiceInterface $flag_service */
        $flag_service = \Drupal::service('flag');
        $flag = $flag_service->getFlagById('subscribe_discussions');

        switch ($invitation->get('status')->value) {
          case InvitationInterface::STATUS_ACCEPTED:
            $flagging = $flag_service->flag($flag, $invitation->getEntity(), $invitation->getOwner());
            if (!empty($flagging)) {
              drupal_set_message(t('You have been subscribed to this discussion.'));
            }
            break;

          case InvitationInterface::STATUS_REJECTED:
            $flagging = $flag_service->getFlagging($flag, $invitation->getEntity(), $invitation->getOwner());
            if (!empty($flagging)) {
              $flagging->delete();
            }
            drupal_set_message(t('You have rejected the invitation to this discussion.'));
            break;
        }
      }
      break;
  }
}
